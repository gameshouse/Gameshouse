<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Mix & Match Pro - Final Balance</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* --- CSS Styles --- */
        :root {
            --bg-color-light: #f0f8ff; --card-bg-light: #ffffff; --text-color-light: #333d4f;
            --accent-color-light-1: #007bff; --accent-color-light-2: #28a745; --border-color-light: #ced4da;
            --shadow-light: 0 6px 24px rgba(0, 123, 255, 0.15); --matched-overlay-light: rgba(40, 167, 69, 0.7);
            --ad-bg-light: #ffc107; --score-color-light: #fd7e14; --celebration-bg-light: linear-gradient(135deg, #56ccf2, #2f80ed);
            --hint-color-light: #6f42c1; --combo-color-light: #dc3545; --cleared-color-light: #17a2b8;
            --moves-warning-color-light: #ff7f50;

            --bg-color-dark: #1a202c; --card-bg-dark: #2d3748; --text-color-dark: #e2e8f0;
            --accent-color-dark-1: #4299e1; --accent-color-dark-2: #48bb78; --border-color-dark: #4a5568;
            --shadow-dark: 0 6px 24px rgba(0, 0, 0, 0.3); --matched-overlay-dark: rgba(72, 187, 120, 0.6);
            --ad-bg-dark: #f6ad55; --score-color-dark: #f6ad55; --celebration-bg-dark: linear-gradient(135deg, #4776e6, #8e54e9);
            --hint-color-dark: #b794f4; --combo-color-dark: #f56565; --cleared-color-dark: #38b2ac;
            --moves-warning-color-dark: #ffa07a;

            --bg-color: var(--bg-color-light); --card-bg: var(--card-bg-light); --text-color: var(--text-color-light);
            --accent-color-1: var(--accent-color-light-1); --accent-color-2: var(--accent-color-light-2); --border-color: var(--border-color-light);
            --shadow: var(--shadow-light); --matched-overlay: var(--matched-overlay-light); --ad-bg: var(--ad-bg-light);
            --score-color: var(--score-color-light); --celebration-bg: var(--celebration-bg-light); --hint-color: var(--hint-color-light);
            --combo-color: var(--combo-color-light); --cleared-color: var(--cleared-color-light);
            --moves-warning-color: var(--moves-warning-color-light);

            --card-size: 70px; --gap-size: 10px; --modal-bg-opacity: rgba(0, 0, 0, 0.75);
        }
        .dark-mode {
            --bg-color: var(--bg-color-dark); --card-bg: var(--card-bg-dark); --text-color: var(--text-color-dark);
            --accent-color-1: var(--accent-color-dark-1); --accent-color-2: var(--accent-color-dark-2); --border-color: var(--border-color-dark);
            --shadow: var(--shadow-dark); --matched-overlay: var(--matched-overlay-dark); --ad-bg: var(--ad-bg-dark);
            --score-color: var(--score-color-dark); --celebration-bg: var(--celebration-bg-dark); --hint-color: var(--hint-color-dark);
            --combo-color: var(--combo-color-dark); --cleared-color: var(--cleared-color-dark);
            --moves-warning-color: var(--moves-warning-color-dark);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Segoe UI', sans-serif; }
        body { display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 100vh; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.4s ease, color 0.4s ease; padding: 10px 0; position: relative; overflow-x: hidden; }

        /* Ad Banner Styles */
        .ad-banner { width: 95%; max-width: 728px; height: 70px; background-color: var(--ad-bg); color: #333; display: flex; justify-content: center; align-items: center; font-weight: bold; border-radius: 8px; margin: 10px auto; box-shadow: var(--shadow); transition: background-color 0.4s ease; flex-shrink: 0; font-size: 0.9em; text-align: center; padding: 5px; }
        .ad-banner.top { margin-bottom: 15px; } .ad-banner.bottom { margin-top: 15px; }
        @media (max-width: 760px) { .ad-banner { height: 60px; font-size: 0.8em;} } @media (max-width: 400px) { .ad-banner { height: 50px; font-size: 0.7em;} }

        /* Pop-up Ad Styles */
        .popup-ad-container { width: 100%; max-width: 300px; height: 250px; margin: 0 auto 20px auto; background-color: var(--ad-bg); color: #333; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); padding: 10px; cursor: pointer; position: relative; overflow: hidden; }
        .popup-ad-container:hover { transform: scale(1.02); transition: transform 0.3s ease; }
        .popup-ad-container::after { content: "Ad"; position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.7em; }

        /* Game Container & Info */
        .game-container { display: flex; flex-direction: column; align-items: center; padding: clamp(15px, 3vw, 20px) clamp(15px, 4vw, 25px); background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); transition: background-color 0.4s ease, box-shadow 0.4s ease; max-width: 95%; width: fit-content; z-index: 1; margin: auto 10px; }
        h1 { font-size: clamp(1.6em, 4vw, 2.1em); margin-bottom: 5px; color: var(--accent-color-1); text-shadow: 1px 1px 3px rgba(0,0,0,0.1); font-weight: 600; }
        .game-info { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 8px 15px; width: 100%; margin-bottom: 15px; font-size: clamp(0.8em, 2.5vw, 0.9em); color: var(--text-color); text-align: center; }
        .game-info > div { padding: 3px 6px; background: rgba(127, 140, 141, 0.08); border-radius: 4px; }
        .game-info span { font-weight: bold; } #score-display span { color: var(--score-color); } #level-display { color: var(--accent-color-2); font-weight: 500;} #hints-display span { color: var(--hint-color); } #levels-cleared-display span { color: var(--cleared-color); } #highest-level-display span { color: var(--accent-color-1); }

        /* Stats (Time/Moves) */
        .stats { display: flex; justify-content: space-evenly; width: 100%; margin-bottom: 15px; font-size: clamp(0.9em, 3vw, 1.0em); gap: 15px; }
        .stats > div { padding: 5px 10px; border-radius: 5px; min-width: 80px; text-align: center; background: rgba(127, 140, 141, 0.08); }
        .stats span { font-weight: bold; color: var(--accent-color-1); }
        #moves-info.warning { color: var(--moves-warning-color); font-weight: bold; animation: pulseWarning 1.5s infinite ease-in-out; }
        @keyframes pulseWarning { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        
        /* Button pulse animation for ad buttons */
        @keyframes pulseButton { 
            0%, 100% { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,123,255,0.4); } 
            50% { transform: scale(1.1); box-shadow: 0 4px 20px rgba(0,123,255,0.6); } 
        }

        /* Combo Message */
        #combo-message { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 1.3em; font-weight: bold; color: var(--combo-color); opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; text-shadow: 1px 1px 2px rgba(255,255,255,0.7); pointer-events: none; z-index: 5; }
        #combo-message.show { opacity: 1; transform: translateX(-50%) translateY(-5px); }

        /* Game Board & Cards */
        .game-board-area { position: relative; margin-bottom: 20px; }
        .game-board { display: grid; gap: var(--gap-size); perspective: 1200px; }
        .card { width: var(--card-size); height: var(--card-size); position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); opacity: 1; visibility: visible; display: block; }
        .card.hint-reveal .card-face { border: 2px solid var(--hint-color); }
        .card.flipped, .card.matched { transform: rotateY(180deg); cursor: default; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card.matched { animation: pulse 0.5s ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: rotateY(180deg) scale(1); } 50% { transform: rotateY(180deg) scale(1.06); } }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; font-size: calc(var(--card-size) * 0.6); border-radius: 10px; border: 1px solid var(--border-color); transition: background-color 0.4s ease, border-color 0.4s ease; }
        .card-front { background: linear-gradient(145deg, var(--accent-color-1), var(--accent-color-2)); color: white; }
        .card-front::before { content: '?'; font-size: calc(var(--card-size) * 0.7); opacity: 0.9; font-weight: bold; }
        .card-back { background-color: var(--card-bg); transform: rotateY(180deg); color: var(--text-color); border-color: var(--accent-color-1); }
        .card.matched .card-back { opacity: 0.8; border-color: var(--accent-color-2);}
        .card.matched .card-back::after { content: 'âœ”'; position: absolute; font-size: calc(var(--card-size) * 0.5); color: white; background: var(--matched-overlay); width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; border-radius: 8px; opacity: 1; font-weight: bold; }

        /* Controls */
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: clamp(8px, 1.5vw, 10px); margin-top: 15px; width: 100%; }
        button { padding: clamp(7px, 1.8vw, 9px) clamp(14px, 3.5vw, 18px); font-size: clamp(0.8em, 2.5vw, 0.9em); font-weight: 500; cursor: pointer; border: none; border-radius: 20px; background: linear-gradient(145deg, var(--accent-color-1), var(--accent-color-2)); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease; letter-spacing: 0.5px; white-space: nowrap; }
        button:hover:not(:disabled) { transform: translateY(-2px) scale(1.03); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        button:active:not(:disabled) { transform: translateY(0) scale(1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
        #theme-toggle { background: var(--text-color); color: var(--bg-color); } .dark-mode #theme-toggle { background: var(--text-color); color: var(--bg-color); }
        #new-game-btn { background: linear-gradient(145deg, #e74c3c, #c0392b); } #hint-btn { background: linear-gradient(145deg, var(--hint-color), color-mix(in srgb, var(--hint-color) 70%, black)); }

        /* Modal Styles */
        .modal { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: var(--modal-bg-opacity); justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.4s ease; padding: 15px; }
        .modal.show { display: flex; opacity: 1; }
        .modal-content { background: var(--card-bg); padding: clamp(20px, 4vw, 25px) clamp(25px, 5vw, 35px); border-radius: 15px; box-shadow: var(--shadow); color: var(--text-color); text-align: center; max-width: 90%; width: 420px; position: relative; animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { transform: translateY(-25px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-content h2 { color: var(--accent-color-1); margin-bottom: 15px; font-weight: 600; font-size: clamp(1.2em, 4vw, 1.5em); }
        .modal-content p { margin-bottom: 20px; font-size: clamp(0.9em, 3vw, 1.0em); line-height: 1.6; }
        .modal-content ul { text-align: left; margin-bottom: 20px; padding-left: 20px; } .modal-content li { margin-bottom: 8px; font-size: clamp(0.85em, 2.8vw, 0.95em); }
        .modal-content button { margin-top: 10px; margin-left: 5px; margin-right: 5px; }
        .close-btn { position: absolute; top: 8px; right: 12px; font-size: 1.6em; font-weight: bold; width: 30px; height: 30px; line-height: 30px; color: var(--border-color); background: rgba(127, 140, 141, 0.1); border-radius: 50%; cursor: pointer; transition: color 0.3s ease, background-color 0.3s ease; }
        .close-btn:hover { color: var(--accent-color-1); background: rgba(127, 140, 141, 0.2); }

        /* Modal Specific */
        #win-message .final-stats { font-size: 1.1em; font-weight: 500; margin-bottom: 20px; display: none; } #win-message .final-stats span { color: var(--score-color); font-weight: bold; }
        #celebration-modal { background: none; overflow: hidden; } #celebration-modal .modal-content { background: var(--celebration-bg); color: white; }
        #celebration-modal h2 { color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); font-size: 1.8em; } #celebration-modal p { font-size: 1.2em; font-weight: 500; } #celebration-modal .close-btn { display: none; }
        #hint-ad-modal button#watch-hint-ad-btn, #out-of-moves-modal button#watch-moves-ad-btn, #interstitial-ad button#continue-btn { background: linear-gradient(145deg, var(--accent-color-2), color-mix(in srgb, var(--accent-color-2) 70%, black)); } /* Green buttons */
        #out-of-moves-modal button#try-again-btn { background: linear-gradient(145deg, #e74c3c, #c0392b); } /* Red button */

        /* Ad Counting Display (for debugging) */
        .ad-clicked-indicator { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; display: none; }

        /* Responsive */
        @media (max-width: 768px) { :root { --card-size: 60px; --gap-size: 8px; } }
        @media (max-width: 480px) { :root { --card-size: 48px; --gap-size: 6px; } .game-info { flex-direction: column; align-items: center; gap: 5px; } .stats { flex-direction: row; justify-content: space-evenly; } }
        @media (max-width: 360px) { :root { --card-size: 42px; --gap-size: 5px; } }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Top Banner Ad -->
    <div class="ad-banner top">
    <script type="text/javascript">
        atOptions = {
            'key' : 'f13b9aebb338988dc9099e067dd01302',
            'format' : 'iframe',
            'height' : 90,
            'width' : 728,
            'params' : {}
        };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/f13b9aebb338988dc9099e067dd01302/invoke.js"></script>
    </div>

    <div class="game-container">
        <h1>Ultimate Mix & Match</h1>
        <div class="game-info">
            <div id="level-display">Level: Easy</div>
            <div id="score-display">Score: <span>0</span></div>
            <div id="highest-level-display">Highest: <span>None</span></div>
            <div id="levels-cleared-display">Cleared: <span>0</span></div>
            <div id="hints-display">Hints: <span id="hints-remaining">3</span></div>
        </div>

        <div class="stats">
            <div>Time: <span id="timer">0s</span></div>
            <div id="moves-info">Moves: <span id="moves">0</span> / <span id="moves-limit">?</span></div>
        </div>

        <div class="game-board-area">
            <div id="combo-message"></div>
            <div class="game-board" id="game-board">
                <!-- Cards will be populated here -->
            </div>
        </div>

        <div class="controls">
            <button id="restart-btn">Restart</button>
            <button id="new-game-btn">New Game</button>
            <button id="hint-btn">Hint (<span id="hint-btn-count">3</span>)</button>
            <button id="rules-btn">Rules</button>
            <button id="theme-toggle">Dark Mode</button>
            <button id="share-btn">Share</button>
        </div>
    </div>

    <!-- Bottom Banner Ad -->
    <div class="ad-banner bottom">
    <script type="text/javascript">
        atOptions = {
            'key' : 'f13b9aebb338988dc9099e067dd01302',
            'format' : 'iframe',
            'height' : 90,
            'width' : 728,
            'params' : {}
        };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/f13b9aebb338988dc9099e067dd01302/invoke.js"></script>
    </div>

    <!-- Modals -->
    <div id="win-message" class="modal"> 
        <div class="modal-content"> 
            <span class="close-btn" onclick="hideModal('win-message')">Ã—</span> 
            <h2 id="win-title">Congratulations! ðŸŽ‰</h2> 
            <p id="win-stats">Level Complete!</p> 
            <div class="final-stats"> 
                Final Score: <span id="final-score">0</span><br> 
                Highest Level: <span id="final-highest-level">Easy</span> 
            </div> 
            <button id="play-again-btn">Play Again (Level 1)</button> 
        </div> 
    </div>
    
    <div id="rules-modal" class="modal"> 
        <div class="modal-content"> 
            <span class="close-btn" onclick="hideModal('rules-modal')">Ã—</span> 
            <h2>How to Play</h2> 
            <ul> 
                <li>Goal: Find all matching pairs.</li> 
                <li>Click cards to flip. Matches stay open âœ¨. Mismatches flip back ðŸ¤”.</li> 
                <li>Level 1: 20 Moves, Level 2: 25 Moves, Level 3+: 30 Moves.</li> 
                <li>Earn points for speed & fewer moves. Get Combo bonuses!</li> 
                <li>Out of moves? Watch an ad for +10 (once per level try).</li> 
                <li>Use 'Hint' if stuck (3 hints per level, but 3rd hint requires ad).</li> 
                <li>Complete levels to unlock harder ones.</li> 
                <li>Ad shown after every 3 completed levels.</li>
                <li>Progress saved automatically. Enjoy!</li> 
            </ul> 
            <button onclick="hideModal('rules-modal')">Got it!</button> 
        </div> 
    </div>
    
    <div id="celebration-modal" class="modal"> 
        <div class="modal-content"> 
            <h2 id="celebration-title">Level Complete!</h2> 
            <p id="celebration-stats">Score: +<span id="level-score">0</span></p> 
        </div> 
    </div>
    
    <!-- Hint Ad Modal -->
    <div id="hint-ad-modal" class="modal"> 
    <div class="modal-content"> 
        <span class="close-btn" onclick="hideModal('hint-ad-modal')">Ã—</span> 
        <h2>Watch Ad for Hint?</h2> 
        <p>Click on the ad below to get your hint!</p> 
        <div class="popup-ad-container" id="hint-ad-placeholder" onclick="registerAdClick('hint')">
            <script type="text/javascript">
                atOptions = {
                    'key' : '8446eb731faeed6b7e16b794c774dfef',
                    'format' : 'iframe',
                    'height' : 250,
                    'width' : 300,
                    'params' : {}
                };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/8446eb731faeed6b7e16b794c774dfef/invoke.js"></script>
        </div>
        <button id="watch-hint-ad-btn" disabled>Continue (After Ad Click)</button>
        <button onclick="hideModal('hint-ad-modal')">No Thanks</button> 
    </div> 
</div>
    
    <!-- Out of Moves Ad Modal -->
    <div id="out-of-moves-modal" class="modal"> 
    <div class="modal-content"> 
        <h2>Out of Moves!</h2> 
        <p>Click on the ad below to get +10 extra moves!</p> 
        <div class="popup-ad-container" id="moves-ad-placeholder" onclick="registerAdClick('moves')">
            <script type="text/javascript">
                atOptions = {
                    'key' : '8446eb731faeed6b7e16b794c774dfef',
                    'format' : 'iframe',
                    'height' : 250,
                    'width' : 300,
                    'params' : {}
                };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/8446eb731faeed6b7e16b794c774dfef/invoke.js"></script>
        </div>
        <button id="watch-moves-ad-btn" disabled>Get +10 Moves (After Ad Click)</button>
        <button id="try-again-btn">Try Again</button> 
    </div> 
</div>
    
    <!-- Interstitial Ad Modal -->
    <div id="interstitial-ad" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="skipInterstitialAdAndContinue()">Ã—</span>
            <h2>Advertisement</h2>
            <p>Click on the ad to continue to the next level!</p>
            <!-- Pop-up Ad Container for Interstitial -->
            <div class="popup-ad-container" id="interstitial-ad-placeholder" onclick="registerAdClick('interstitial')">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '9cd94253e852b6ee34ddf00c801c1a34',
                        'format' : 'iframe',
                        'height' : 250,
                        'width' : 300,
                        'params' : {}
                    };
                    document.write('<scr' + 'ipt type="text/javascript" src="//www.highperformanceformat.com/9cd94253e852b6ee34ddf00c801c1a34/invoke.js"></scr' + 'ipt>');
                </script>
            </div>
            <button id="continue-interstitial-btn" disabled>Continue (After Ad Click)</button>
        </div>
    </div>

    <!-- Ad Click Indicator (for debugging) -->
    <div class="ad-clicked-indicator" id="ad-clicked-indicator">Ad Clicked!</div>

    <script>
        // --- DOM Elements ---
        const gameBoard = document.getElementById('game-board');
        const movesInfoDiv = document.getElementById('moves-info');
        const movesSpan = document.getElementById('moves');
        const movesLimitSpan = document.getElementById('moves-limit');
        const timerSpan = document.getElementById('timer');
        const levelDisplay = document.getElementById('level-display');
        const scoreDisplay = document.getElementById('score-display').querySelector('span');
        const highestLevelDisplay = document.getElementById('highest-level-display').querySelector('span');
        const levelsClearedDisplay = document.getElementById('levels-cleared-display').querySelector('span');
        const hintsDisplay = document.getElementById('hints-remaining');
        const restartBtn = document.getElementById('restart-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const hintBtn = document.getElementById('hint-btn');
        const hintBtnCount = document.getElementById('hint-btn-count');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const shareBtn = document.getElementById('share-btn');
        const rulesBtn = document.getElementById('rules-btn');
        const comboMessage = document.getElementById('combo-message');
        const winMessageDiv = document.getElementById('win-message');
        const winTitle = document.getElementById('win-title');
        const winStatsP = document.getElementById('win-stats');
        const finalStatsDiv = winMessageDiv.querySelector('.final-stats');
        const finalScoreSpan = document.getElementById('final-score');
        const finalHighestLevelSpan = document.getElementById('final-highest-level');
        const playAgainBtn = document.getElementById('play-again-btn');
        const rulesModal = document.getElementById('rules-modal');
        const celebrationModal = document.getElementById('celebration-modal');
        const celebrationTitle = document.getElementById('celebration-title');
        const celebrationStats = document.getElementById('celebration-stats');
        const levelScoreSpan = document.getElementById('level-score');
        const hintAdModal = document.getElementById('hint-ad-modal');
        const watchHintAdBtn = document.getElementById('watch-hint-ad-btn');
        const outOfMovesModal = document.getElementById('out-of-moves-modal');
        const watchMovesAdBtn = document.getElementById('watch-moves-ad-btn');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const interstitialAdModal = document.getElementById('interstitial-ad');
        const continueInterstitialBtn = document.getElementById('continue-interstitial-btn');
        const adClickedIndicator = document.getElementById('ad-clicked-indicator');

        // Emojis & Levels Config (All levels have 3 hints)
        const allEmojis = ['ðŸŽ', 'ðŸŒ', 'ðŸ‡', 'ðŸ‰', 'ðŸ“', 'ðŸ’', 'ðŸ‘', 'ðŸ', 'ðŸ¥', 'ðŸ¥­', 'ðŸ¥¥', 'ðŸ¥‘', 'ðŸ†', 'ðŸ¥•', 'ðŸŒ½', 'ðŸŒ¶ï¸', 'ðŸ„', 'ðŸ¥¦', 'ðŸ•', 'ðŸ”', 'ðŸŸ', 'ðŸ©', 'ðŸª', 'ðŸŽ‚', 'ðŸ¦', 'ðŸ¿'];
        const levels = {
            easy: { name: 'Easy', pairs: 6, cols: 4, emojis: allEmojis.slice(0, 6), baseScore: 1000, timePenalty: 5, movePenalty: 10, hints: 3 },
            medium: { name: 'Medium', pairs: 8, cols: 4, emojis: allEmojis.slice(0, 8), baseScore: 1500, timePenalty: 7, movePenalty: 15, hints: 3 },
            hard: { name: 'Hard', pairs: 12, cols: 6, emojis: allEmojis.slice(0, 12), baseScore: 2500, timePenalty: 10, movePenalty: 20, hints: 3 },
            expert: { name: 'Expert', pairs: 15, cols: 6, emojis: allEmojis.slice(0, 15), baseScore: 4000, timePenalty: 12, movePenalty: 25, hints: 3 }
        };
        const levelOrder = ['easy', 'medium', 'hard', 'expert'];

        // --- Game State Variables ---
        let flippedCards = []; let matchedPairs = 0; let moves = 0; let timerInterval = null; let seconds = 0;
        let gameLocked = false; let gameStarted = false; let currentLevelKey = levelOrder[0];
        let highestLevelReachedIndex = -1; let totalScore = 0;
        let hintsRemaining = 0; let comboCount = 0; let lastMatchTime = 0; const COMBO_WINDOW = 3000;
        const COMBO_BASE_POINTS = 50; let hintTimeout = null;
        let adWatchedForHintThisLevel = false; let currentMoveLimit = 0; let extraMovesGivenThisLevel = false;
        let levelsCompletedSinceLastAd = 0;
        let interstitialTimer = null;
        
        // Ad click tracking
        let adClicked = {
            hint: false,
            moves: false,
            interstitial: false
        };

        // --- Ad Click Handling ---
        function registerAdClick(adType) {
            console.log(`Ad clicked: ${adType}`);
            adClicked[adType] = true;
            
            // Show indicator for visual feedback
            adClickedIndicator.textContent = `${adType.charAt(0).toUpperCase() + adType.slice(1)} Ad Clicked!`;
            adClickedIndicator.style.display = 'block';
            setTimeout(() => {
                adClickedIndicator.style.display = 'none';
            }, 2000);
            
            // Enable appropriate continue button
            if (adType === 'hint') {
                watchHintAdBtn.disabled = false;
                watchHintAdBtn.textContent = 'Continue';
                watchHintAdBtn.style.animation = "pulseButton 1.5s infinite";
            } else if (adType === 'moves') {
                watchMovesAdBtn.disabled = false;
                watchMovesAdBtn.textContent = 'Get +10 Moves';
                watchMovesAdBtn.style.animation = "pulseButton 1.5s infinite";
            } else if (adType === 'interstitial') {
                continueInterstitialBtn.disabled = false;
                continueInterstitialBtn.textContent = 'Continue to Next Level';
                continueInterstitialBtn.style.animation = "pulseButton 1.5s infinite";
            }
        }

        // --- Utility & Theme Functions ---
        function applyTheme(theme) { document.body.classList.toggle('dark-mode', theme === 'dark'); themeToggleBtn.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode'; localStorage.setItem('mixMatchTheme', theme); }
        function toggleTheme() { const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark'; applyTheme(newTheme); }
        function showModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.classList.add('show'); }
        function hideModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.classList.remove('show'); }
        function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        // --- Progress Management ---
        function loadProgress() {
            const savedLevelIndexStr = localStorage.getItem('mixMatchHighestLevel'); 
            const savedScoreStr = localStorage.getItem('mixMatchTotalScore');
            highestLevelReachedIndex = savedLevelIndexStr ? parseInt(savedLevelIndexStr, 10) : -1; 
            totalScore = savedScoreStr ? parseInt(savedScoreStr, 10) : 0;
            levelsCompletedSinceLastAd = parseInt(localStorage.getItem('mixMatchLevelsSinceAd') || '0', 10);
            let startLevelIndex = (highestLevelReachedIndex >= levelOrder.length - 1) ? 0 : highestLevelReachedIndex + 1;
            currentLevelKey = levelOrder[startLevelIndex] || levelOrder[0];
            updateScoreDisplay(); updateHighestLevelDisplay(); updateLevelsClearedDisplay();
         }
        function saveProgress() {
            localStorage.setItem('mixMatchHighestLevel', highestLevelReachedIndex.toString());
            localStorage.setItem('mixMatchTotalScore', totalScore.toString());
            localStorage.setItem('mixMatchLevelsSinceAd', levelsCompletedSinceLastAd.toString());
        }
        function resetProgress() {
             highestLevelReachedIndex = -1; totalScore = 0; currentLevelKey = levelOrder[0];
             levelsCompletedSinceLastAd = 0;
             saveProgress();
             updateScoreDisplay(); updateHighestLevelDisplay(); updateLevelsClearedDisplay();
         }

        // --- UI Updates ---
        function updateScoreDisplay() { scoreDisplay.textContent = totalScore; }
        function updateHighestLevelDisplay() { let displayLevelName = "None"; if (highestLevelReachedIndex >= 0 && highestLevelReachedIndex < levelOrder.length) { displayLevelName = levels[levelOrder[highestLevelReachedIndex]].name; } highestLevelDisplay.textContent = displayLevelName; }
        function updateTimerDisplay() { timerSpan.textContent = `${seconds}s`; }
        function updateHintsDisplay() { hintsDisplay.textContent = hintsRemaining; hintBtnCount.textContent = hintsRemaining; hintBtn.disabled = hintsRemaining <= 0; }
        function showComboMessage(count) { 
            if (count <= 1) return; 
            comboMessage.textContent = `Combo x${count}! +${(count -1) * COMBO_BASE_POINTS}`; 
            comboMessage.classList.add('show'); 
            setTimeout(() => { comboMessage.classList.remove('show'); }, 1200); 
        }
        function updateLevelsClearedDisplay() { const clearedCount = highestLevelReachedIndex + 1; levelsClearedDisplay.textContent = clearedCount; }
        function updateMovesDisplay() { movesSpan.textContent = moves; movesLimitSpan.textContent = currentMoveLimit; if (currentMoveLimit > 0 && currentMoveLimit - moves <= 5 && currentMoveLimit - moves > 0) { movesInfoDiv.classList.add('warning'); } else { movesInfoDiv.classList.remove('warning'); } }

        // --- Calculate Move Limit ---
        function calculateMoveLimit(levelKey) {
            const levelIndex = levelOrder.indexOf(levelKey);
            if (levelIndex === 0) return 20; // Level 1
            if (levelIndex === 1) return 25; // Level 2
            return 30; // Level 3 and onwards
        }

        // --- Game Setup: createBoard() ---
        function createBoard() {
            console.log(`--- Creating board for level: ${currentLevelKey} ---`);
            gameBoard.innerHTML = '';
            matchedPairs = 0; moves = 0; seconds = 0; gameStarted = false; gameLocked = false;
            flippedCards = []; comboCount = 0; lastMatchTime = 0; adWatchedForHintThisLevel = false; extraMovesGivenThisLevel = false;
            clearTimeout(hintTimeout); stopTimer();
            hideModal('win-message'); hideModal('celebration-modal'); hideModal('hint-ad-modal'); hideModal('out-of-moves-modal'); hideModal('interstitial-ad');
            comboMessage.classList.remove('show'); movesInfoDiv.classList.remove('warning');
            
            // Reset ad click tracking
            adClicked = { hint: false, moves: false, interstitial: false };
            
            // Reset button states
            watchHintAdBtn.disabled = true;
            watchHintAdBtn.textContent = "Continue (After Ad Click)";
            watchHintAdBtn.style.animation = "none";
            
            watchMovesAdBtn.disabled = true;
            watchMovesAdBtn.textContent = "Get +10 Moves (After Ad Click)";
            watchMovesAdBtn.style.animation = "none";
            
            continueInterstitialBtn.disabled = true;
            continueInterstitialBtn.textContent = "Continue (After Ad Click)";
            continueInterstitialBtn.style.animation = "none";

            const levelConfig = levels[currentLevelKey];
            if (!levelConfig) { console.error("Invalid level key, defaulting to easy."); currentLevelKey = levelOrder[0]; levelConfig = levels[currentLevelKey]; }

            hintsRemaining = levelConfig.hints; updateHintsDisplay();
            currentMoveLimit = calculateMoveLimit(currentLevelKey);
            updateMovesDisplay(); updateLevelsClearedDisplay();
            levelDisplay.textContent = `Level: ${levelConfig.name}`; 
            let cardValues = shuffle([...levelConfig.emojis, ...levelConfig.emojis]);

            const columns = levelConfig.cols; 
            const baseSize = 70; 
            const scaleFactor = columns > 4 ? (columns > 5 ? 0.8 : 0.9) : 1; 
            const finalCardSize = Math.max(40, baseSize * scaleFactor); 
            document.documentElement.style.setProperty('--card-size', `${finalCardSize}px`); 
            gameBoard.style.gridTemplateColumns = `repeat(${columns}, var(--card-size))`;

            // --- Card Creation Loop ---
            cardValues.forEach(value => { 
                const card = document.createElement('div'); 
                card.classList.add('card'); 
                card.dataset.value = value; 
                card.innerHTML = `<div class="card-face card-front"></div><div class="card-face card-back">${value}</div>`; 
                card.addEventListener('click', handleCardClick); 
                gameBoard.appendChild(card); 
            });
            console.log(`--- Board creation complete. ${gameBoard.children.length} cards added. Move Limit: ${currentMoveLimit} ---`);
        }

        // --- Game Logic ---
        function handleCardClick(event) { 
            if (gameLocked || event.currentTarget.classList.contains('matched') || event.currentTarget.classList.contains('flipped')) { 
                return; 
            } 
            if (flippedCards.length === 1 && (moves + 1) > currentMoveLimit) { 
                handleOutOfMoves(); 
                return; 
            } 
            
            const clickedCard = event.currentTarget; 
            if (!gameStarted) { 
                startTimer(); 
                gameStarted = true; 
            } 
            flipCard(clickedCard); 
        }
        
        function flipCard(card) { 
            gameLocked = true; 
            card.classList.add('flipped'); 
            flippedCards.push(card); 
            setTimeout(() => { 
                if(flippedCards.length < 2) gameLocked = false; 
            }, 200); 
            if (flippedCards.length === 2) { 
                gameLocked = true; 
                incrementMoves(); 
                setTimeout(checkForMatch, 600); 
            } 
        }
        
        function checkForMatch() { 
            const [card1, card2] = flippedCards; 
            const isEqual = card1.dataset.value === card2.dataset.value; 
            if (isEqual) { 
                handleMatch(card1, card2); 
            } else { 
                handleMismatch(card1, card2); 
            } 
        }
        
        function handleMatch(card1, card2) { 
            card1.classList.add('matched'); 
            card2.classList.add('matched'); 
            matchedPairs++; 
            const now = Date.now(); 
            if (now - lastMatchTime <= COMBO_WINDOW) { 
                comboCount++; 
            } else { 
                comboCount = 1; 
            } 
            lastMatchTime = now; 
            if (comboCount > 1) { 
                const comboBonus = (comboCount - 1) * COMBO_BASE_POINTS; 
                totalScore += comboBonus; 
                updateScoreDisplay(); 
            } 
            showComboMessage(comboCount); 
            flippedCards = []; 
            gameLocked = false; 
            if (matchedPairs === levels[currentLevelKey].pairs) { 
                stopTimer(); 
                handleLevelComplete(); 
            } 
        }
        
        function handleMismatch(card1, card2) { 
            comboCount = 0; 
            setTimeout(() => { 
                card1.classList.remove('flipped'); 
                card2.classList.remove('flipped'); 
                flippedCards = []; 
                gameLocked = false; 
            }, 900); 
        }

        // --- Hint System Logic --- (Modified to require ad for last hint)
        function attemptUseHint() { 
            if (hintsRemaining <= 0 || gameLocked || flippedCards.length > 0) { 
                return; 
            } 
            
            // Always require ad for last hint (3rd hint)
            if (hintsRemaining === 1 && !adWatchedForHintThisLevel) { 
                showModal('hint-ad-modal'); 
            } else { 
                executeHint(); 
            } 
        }
        
        function handleHintAfterAd() { 
            if (!adClicked.hint) {
                alert("Please click on the ad first to get your hint!");
                return;
            }
            
            hideModal('hint-ad-modal'); 
            console.log("Hint Ad clicked and processed."); 
            adWatchedForHintThisLevel = true; 
            executeHint(); 
            
            // Reset button state
            watchHintAdBtn.disabled = true;
            watchHintAdBtn.textContent = "Continue (After Ad Click)";
            watchHintAdBtn.style.animation = "none";
            adClicked.hint = false;
        }
        
        function executeHint() { 
            if (hintsRemaining <= 0 || gameLocked || flippedCards.length > 0) { 
                return; 
            } 
            
            hintsRemaining--; 
            updateHintsDisplay(); 
            gameLocked = true; 
            const unmatchedCards = Array.from(gameBoard.querySelectorAll('.card:not(.matched):not(.flipped)')); 
            let card1 = null, card2 = null; 
            const foundValues = {}; 
            for (const card of unmatchedCards) { 
                const value = card.dataset.value; 
                if (foundValues[value]) { 
                    card1 = foundValues[value]; 
                    card2 = card; 
                    break; 
                } 
                foundValues[value] = card; 
            } 
            if (card1 && card2) { 
                card1.classList.add('flipped', 'hint-reveal'); 
                card2.classList.add('flipped', 'hint-reveal'); 
                clearTimeout(hintTimeout); 
                hintTimeout = setTimeout(() => { 
                    card1.classList.remove('flipped', 'hint-reveal'); 
                    card2.classList.remove('flipped', 'hint-reveal'); 
                    gameLocked = false; 
                }, 1000); 
            } else { 
                console.warn("No suitable pair found for hint."); 
                hintsRemaining++; 
                updateHintsDisplay(); 
                gameLocked = false; 
            } 
        }

        // --- Move Limit Handling --- (Enhanced for ad integration)
        function incrementMoves() { 
            moves++; 
            updateMovesDisplay(); 
        }
        
        function handleOutOfMoves() { 
            gameLocked = true; 
            stopTimer(); 
            
            // Enhanced: Highlight the ad button if not used yet
            if (!extraMovesGivenThisLevel) {
                watchMovesAdBtn.style.animation = "none"; // Reset first
                setTimeout(() => {
                    watchMovesAdBtn.style.animation = "pulseButton 1.5s infinite";
                }, 10);
            }
            
            watchMovesAdBtn.disabled = extraMovesGivenThisLevel;
            showModal('out-of-moves-modal'); 
        }
        
        function handleMovesAfterAd() { 
            if (!adClicked.moves) {
                alert("Please click on the ad first to get extra moves!");
                return;
            }
            
            hideModal('out-of-moves-modal'); 
            console.log("Moves Ad clicked and processed..."); 
            gameLocked = true; 
            
            // Reset button styling
            watchMovesAdBtn.style.animation = "none";
            watchMovesAdBtn.textContent = "Get +10 Moves (After Ad Click)";
            
            setTimeout(() => { 
                console.log("Extra moves granted."); 
                currentMoveLimit += 10; 
                extraMovesGivenThisLevel = true; 
                gameLocked = false; 
                updateMovesDisplay(); 
                adClicked.moves = false;
                watchMovesAdBtn.disabled = true;
            }, 1000); 
        }
        
        function handleLevelFailFromMoves() { 
            hideModal('out-of-moves-modal'); 
            restartCurrentLevel(); 
        }

        // --- Score Calculation ---
        function calculateLevelScore() { 
            const levelConfig = levels[currentLevelKey]; 
            const timeScorePenalty = seconds * levelConfig.timePenalty; 
            const moveScorePenalty = moves * levelConfig.movePenalty; 
            let levelScore = Math.max(0, levelConfig.baseScore - timeScorePenalty - moveScorePenalty); 
            levelScore = Math.max(10, levelScore); 
            return Math.round(levelScore); 
        }

        // --- Level Complete & Progression ---
        function handleLevelComplete() {
            const levelScore = calculateLevelScore(); 
            totalScore += levelScore; 
            updateScoreDisplay();
            const currentLevelIndex = levelOrder.indexOf(currentLevelKey);
            if (currentLevelIndex > highestLevelReachedIndex) { 
                highestLevelReachedIndex = currentLevelIndex; 
                updateHighestLevelDisplay(); 
                updateLevelsClearedDisplay(); 
            }
            levelsCompletedSinceLastAd++;
            saveProgress();
            showCelebration(levelScore);
        }
        
        function showCelebration(levelScore) {
            levelScoreSpan.textContent = levelScore; 
            celebrationTitle.textContent = `${levels[currentLevelKey].name} Complete!`; 
            showModal('celebration-modal');
            
            if (typeof confetti === 'function') { 
                const duration = 2 * 1000; 
                const animationEnd = Date.now() + duration; 
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1001 }; 
                
                function randomInRange(min, max) { 
                    return Math.random() * (max - min) + min; 
                } 
                
                const interval = setInterval(function() { 
                    const timeLeft = animationEnd - Date.now(); 
                    if (timeLeft <= 0) { 
                        return clearInterval(interval); 
                    } 
                    const particleCount = 50 * (timeLeft / duration); 
                    confetti(Object.assign({}, defaults, { 
                        particleCount, 
                        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }, 
                        colors: ['#FFD700', '#FFFFFF', '#00BFFF', '#FF69B4'], 
                        shapes: ['star'] 
                    })); 
                    confetti(Object.assign({}, defaults, { 
                        particleCount, 
                        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }, 
                        colors: ['#FFD700', '#FFFFFF', '#28a745', '#FFA500'], 
                        shapes: ['circle'] 
                    })); 
                }, 250); 
            } else { 
                console.warn("Confetti function not found."); 
            }
            
            setTimeout(() => { 
                hideModal('celebration-modal'); 
                proceedAfterCelebration(); 
            }, 2500);
        }
        
        function proceedAfterCelebration() {
            const currentLevelIndex = levelOrder.indexOf(currentLevelKey);
            const isLastLevel = currentLevelIndex === levelOrder.length - 1;

            if (isLastLevel) {
                showFinalWinScreen();
            } else if (levelsCompletedSinceLastAd >= 3) {
                levelsCompletedSinceLastAd = 0;
                saveProgress();
                showModal('interstitial-ad');
                
                clearTimeout(interstitialTimer);
                interstitialTimer = setTimeout(() => {
                    if (interstitialAdModal.classList.contains('show') && !adClicked.interstitial) {
                        // Only auto-proceed if no ad click yet
                        skipInterstitialAdAndContinue();
                    }
                }, 10000); // Give 10 seconds for ad interaction
            } else {
                setupNextLevel();
            }
        }
        
        function handleInterstitialAfterClick() {
            if (!adClicked.interstitial) {
                alert("Please click on the ad first to continue!");
                return;
            }
            
            skipInterstitialAdAndContinue();
            adClicked.interstitial = false;
        }
        
        function setupNextLevel() {
             const currentLevelIndex = levelOrder.indexOf(currentLevelKey); 
             const nextLevelIndex = currentLevelIndex + 1;
             if (nextLevelIndex < levelOrder.length) { 
                 currentLevelKey = levelOrder[nextLevelIndex]; 
                 setTimeout(createBoard, 200); 
             } else { 
                 showFinalWinScreen(); 
             }
        }
        
        function skipInterstitialAdAndContinue() {
             hideModal('interstitial-ad'); 
             clearTimeout(interstitialTimer);
             continueInterstitialBtn.disabled = true;
             continueInterstitialBtn.textContent = "Continue (After Ad Click)";
             continueInterstitialBtn.style.animation = "none";
             setupNextLevel();
         }
        
        function showFinalWinScreen() {
            winTitle.textContent = "You've beaten all levels! ðŸ†";
            winStatsP.textContent = `Congratulations! You've completed every level in the game.`;
            finalScoreSpan.textContent = totalScore;
            finalHighestLevelSpan.textContent = levels[levelOrder[highestLevelReachedIndex]].name;
            finalStatsDiv.style.display = 'block';
            showModal('win-message');
        }

        // --- Timer & Moves ---
        function startTimer() { 
            stopTimer(); 
            seconds = 0; 
            updateTimerDisplay(); 
            timerInterval = setInterval(() => { 
                seconds++; 
                updateTimerDisplay(); 
            }, 1000); 
        }
        
        function stopTimer() { 
            clearInterval(timerInterval); 
            timerInterval = null; 
        }

        // --- Restart / New Game / Share ---
        function restartCurrentLevel() { 
            stopTimer(); 
            createBoard(); 
        }
        
        function startNewGame() { 
            stopTimer(); 
            if (confirm("Start a new game? This will reset your score and progress.")) { 
                resetProgress(); 
                createBoard(); 
            } 
        }
        
        async function shareScore() {
            const text = `I scored ${totalScore} points in Ultimate Mix & Match! My highest level: ${levels[levelOrder[Math.max(0, highestLevelReachedIndex)]].name}`;
            try {
                if (navigator.share) {
                    await navigator.share({
                        title: 'Ultimate Mix & Match Score',
                        text: text
                    });
                } else {
                    alert(`Share this score: ${text}`);
                }
            } catch(e) {
                console.error('Sharing failed:', e);
                alert(`Share this score: ${text}`);
            }
        }

        // --- Event Listeners ---
        restartBtn.addEventListener('click', restartCurrentLevel);
        newGameBtn.addEventListener('click', startNewGame);
        hintBtn.addEventListener('click', attemptUseHint);
        watchHintAdBtn.addEventListener('click', handleHintAfterAd);
        themeToggleBtn.addEventListener('click', toggleTheme);
        shareBtn.addEventListener('click', shareScore);
        rulesBtn.addEventListener('click', () => showModal('rules-modal'));
        playAgainBtn.addEventListener('click', () => { hideModal('win-message'); startNewGame(); });
        watchMovesAdBtn.addEventListener('click', handleMovesAfterAd);
        tryAgainBtn.addEventListener('click', handleLevelFailFromMoves);
        continueInterstitialBtn.addEventListener('click', handleInterstitialAfterClick);
        interstitialAdModal.querySelector('.close-btn').addEventListener('click', skipInterstitialAdAndContinue);

        // --- Initial Game Load ---
        document.addEventListener('DOMContentLoaded', () => {
             const savedTheme = localStorage.getItem('mixMatchTheme') || 'light'; 
             applyTheme(savedTheme);
             loadProgress(); 
             createBoard();
        });
    </script>
</body>
</html>
